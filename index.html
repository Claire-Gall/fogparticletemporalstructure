<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fog Paths</title>
  <style>
    body {
      background-color: #ffffff;
      font-family: 'Courier New', Courier, monospace, sans-serif;
      margin: 0;
      padding: 20px;
    }

    #chart {
      background-color: #fff;
      padding: 10px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .glow {
      filter: url(#glow-filter);
    }

    .trail {
      fill: none;
      stroke: grey;
      stroke-width: 1;
      stroke-linecap: round;
      opacity: 0.5;
    }
  </style>
</head>
<body>

  <h2 style="text-align:center;">Fog Particle Paths</h2>
  <div id="chart"></div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    const width = 1200;
    const height = 600;
    const margin = { top: 20, right: 20, bottom: 30, left: 40 };

    const svg = d3.select("#chart")
      .append("svg")
      .attr("width", width)
      .attr("height", height);

    // Glow filter
    const defs = svg.append("defs");
    const glowFilter = defs.append("filter").attr("id", "glow-filter");
    glowFilter.append("feGaussianBlur").attr("stdDeviation", 6).attr("result", "blur");
    const feMerge = glowFilter.append("feMerge");
    feMerge.append("feMergeNode").attr("in", "blur");
    feMerge.append("feMergeNode").attr("in", "SourceGraphic");

    const x = d3.scaleLinear().domain([0, 100]).range([margin.left, width - margin.right]);
    const y = d3.scaleLinear().domain([0, height]).range([margin.top, height - margin.bottom]);

    // Generate 100 lines
    const lineCount = 100;
    const lines = Array.from({ length: lineCount }, (_, i) => {
      const xPos = i;
      const coordinates = [
        [xPos, 0],
        [xPos + (Math.random() * 2 - 1), 100],
        [xPos + (Math.random() * 2 - 1), 200],
        [xPos + (Math.random() * 2 - 1), 300],
        [xPos + (Math.random() * 2 - 1), 400],
        [xPos + (Math.random() * 2 - 1), 500],
        [xPos + (Math.random() * 2 - 1), 600],
      ];
      return {
        name: `Line${i}`,
        coordinates,
        delay: i * 20
      };
    });

    const lineGenerator = d3.line()
      .x(d => x(d[0]))
      .y(d => y(d[1]));

    lines.forEach(lineData => {
      const path = svg.append("path")
        .datum(lineData.coordinates)
        .attr("d", lineGenerator)
        .attr("fill", "none")
        .attr("stroke", "grey")
        .attr("stroke-width", 1)
        .attr("class", `path-${lineData.name}`);

      const pathNode = path.node();
      const totalLength = pathNode.getTotalLength();

      // Glow
      const glow = svg.append("circle")
        .attr("r", 10)
        .attr("fill", "grey")
        .attr("class", "glow")
        .style("opacity", 0.3);

      // Main point
      const point = svg.append("circle")
        .attr("r", 3)
        .attr("fill", "grey");

      // Trail path
      const trail = svg.append("path")
        .attr("class", "trail");

      // Animate
      function animate() {
        const duration = 8000;

        // Animate point and glow
        point.transition()
          .delay(lineData.delay)
          .duration(duration)
          .ease(d3.easeLinear)
          .attrTween("transform", function () {
            return function (t) {
              const pt = pathNode.getPointAtLength(t * totalLength);
              return `translate(${pt.x},${pt.y})`;
            };
          });

        glow.transition()
          .delay(lineData.delay)
          .duration(duration)
          .ease(d3.easeLinear)
          .attrTween("transform", function () {
            return function (t) {
              const pt = pathNode.getPointAtLength(t * totalLength);
              return `translate(${pt.x},${pt.y})`;
            };
          });

        // Animate trail
        trail.transition()
          .delay(lineData.delay)
          .duration(duration)
          .ease(d3.easeLinear)
          .attrTween("d", function () {
            return function (t) {
              const subLength = t * totalLength;
              const trailPath = pathNode.getPointAtLength
                ? Array.from({ length: 30 }, (_, j) => {
                    const l = subLength - j * 4;
                    if (l < 0) return null;
                    const pt = pathNode.getPointAtLength(l);
                    return [pt.x, pt.y];
                  }).filter(Boolean)
                : [];

              const trailLine = d3.line()
                .x(d => d[0])
                .y(d => d[1])
                .curve(d3.curveBasis);

              return trailLine(trailPath);
            };
          })
          .on("end", animate);
      }

      animate();
    });
  </script>
</body>
</html>